

// Docs: https://pris.ly/d/prisma-schema
// Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  owner
  admin
  member
  guest
}

// --- 1. CORE USER ---
model User {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username        String       @unique @db.VarChar(50)
  passwordHash    String?      @db.Char(60) // Optional for OAuth users
  email           String       @unique @db.VarChar(255)
  role            UserRole     @default(guest)

  // Relationships
  structuredDocuments StructuredDocument[]
  documentHistory     DocumentHistory[]
  sessions            Session[]
  accounts            Account[]
  categories          Category[]
  viewGrants           ViewGrant[]
}

// --- 2. UNIVERSAL DOCUMENT STORE (CONTENT) ---
model StructuredDocument {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId        String         @db.Uuid
  docType        String         @db.VarChar(50) // e.g., 'Note', 'Project', 'Folder', 'Resume'
  title          String         @db.VarChar(255)
  slug           String         @unique @db.VarChar(255)
  contentData    Json           @db.JsonB // Stores the content (Markdown or structured JSON)
  isPublished    Boolean        @default(false)
  updatedAt      DateTime       @updatedAt @db.Timestamptz()

  // Hierarchy
  parentId       String?        @db.Uuid
  parent         StructuredDocument? @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children       StructuredDocument[] @relation("Hierarchy")

  // Navigation integration
  categoryId     String?        @db.Uuid // Link to Category
  displayOrder   Int            @default(0) // Order within category/parent

  // Relationships
  owner          User             @relation(fields: [ownerId], references: [id])
  category       Category?        @relation(fields: [categoryId], references: [id])
  history        DocumentHistory[]
  documentPaths  DocumentPath?
  sourceLinks    DocumentLink[]   @relation("SourceDocument")
  targetLinks    DocumentLink[]   @relation("TargetDocument")
  documentTags   DocumentTag[]
  viewGrants      ViewGrant[]

  // Indexes (Crucial for performance)
  @@index([ownerId, docType, isPublished])
  @@index([parentId])
  @@index([categoryId, displayOrder])
  @@index([parentId, displayOrder]) // For hierarchical ordering
}

// --- 3. DOCUMENT HISTORY ---
model DocumentHistory {
  id             BigInt         @id @default(autoincrement())
  documentId     String         @db.Uuid
  revisionData   Json           @db.JsonB // Snapshot of the contentData
  editedById     String         @db.Uuid
  editedAt       DateTime       @default(now()) @db.Timestamptz()

  document       StructuredDocument @relation(fields: [documentId], references: [id])
  editor         User               @relation(fields: [editedById], references: [id])

  @@index([documentId])
  @@index([editedAt])
}

// --- 4. DOCUMENT PATHS (MATERIALIZED PATH) ---
model DocumentPath {
  documentId     String         @id @db.Uuid
  pathSlug       String         @unique @db.VarChar(1024) // e.g., 'tech/databases/rcte-guide'
  pathText       String         @unique @db.VarChar(1024) // e.g., 'tech.databases.rcte-guide'
  depth          Int            @db.SmallInt

  document       StructuredDocument @relation(fields: [documentId], references: [id])
}

// --- 5. DOCUMENT LINKS (WIKILINKS, SECTION REFS) ---
model DocumentLink {
  sourceId        String        @db.Uuid
  targetId        String        @db.Uuid
  linkType        String        @db.VarChar(50)
  targetFragment  String?       @db.VarChar(255) // The anchor name (e.g., '#overview')
  displayOrder    Int           @default(0)
  updatedAt       DateTime      @default(now()) @db.Timestamptz()

  source          StructuredDocument @relation("SourceDocument", fields: [sourceId], references: [id])
  target          StructuredDocument @relation("TargetDocument", fields: [targetId], references: [id])

  @@id([sourceId, targetId]) // Composite Primary Key
  @@index([targetId, sourceId]) // For Backlinks
  @@index([targetFragment])
  @@index([displayOrder])
}

// --- 6. TAGGING SYSTEM ---
model Tag {
  id              BigInt         @id @default(autoincrement())
  name            String         @unique @db.VarChar(100) // Standardized tag name
  slug            String         @unique @db.VarChar(100)

  documentTags    DocumentTag[]
}

model DocumentTag {
  documentId      String         @db.Uuid
  tagId           BigInt

  document        StructuredDocument @relation(fields: [documentId], references: [id])
  tag             Tag                @relation(fields: [tagId], references: [id])

  @@id([documentId, tagId]) // Composite Primary Key
  @@index([tagId, documentId]) // For searching documents by tag
}

// --- 7. SESSION MANAGEMENT ---
model Session {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String       @db.Uuid
  token           String       @unique @db.VarChar(255)
  expiresAt       DateTime     @db.Timestamptz()
  createdAt       DateTime     @default(now()) @db.Timestamptz()

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// --- 8. OAUTH ACCOUNTS ---
model Account {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String       @db.Uuid
  provider          String       @db.VarChar(50)
  providerAccountId String       @db.VarChar(255)
  accessToken       String?      @db.Text
  refreshToken      String?      @db.Text
  expiresAt         BigInt?
  createdAt         DateTime     @default(now()) @db.Timestamptz()
  updatedAt         DateTime     @updatedAt @db.Timestamptz()

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
}

// --- 9. NAVIGATION CATEGORIES ---
model Category {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String   @unique @db.VarChar(255)
  slug            String   @unique @db.VarChar(255)
  description     String?  @db.Text
  displayOrder    Int      @default(0) // Vertical position on trunk (0-100)
  branchPreset    String?  @db.VarChar(50) // Optional preset override (e.g., "binary", "trident")
  isPublished     Boolean  @default(true)
  ownerId         String   @db.Uuid
  
  owner           User     @relation(fields: [ownerId], references: [id])
  documents       StructuredDocument[] // Documents belonging to this category
  viewGrants      ViewGrant[]
  
  @@index([ownerId, isPublished, displayOrder])
  @@index([displayOrder])
}

// --- 10. VIEW GRANTS (FILTERED NAVIGATION) ---
model ViewGrant {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  viewKey         String   @db.VarChar(100) // e.g., "portfolio", "family", "tech"
  
  // Grantee (one of these must be set)
  userId          String?  @db.Uuid // Specific user grant
  role            UserRole? // Role-based grant (e.g., all "member" users)
  
  // Target (one of these must be set)
  categoryId      String?  @db.Uuid
  documentId      String?  @db.Uuid
  
  createdAt       DateTime @default(now()) @db.Timestamptz()
  
  user            User?    @relation(fields: [userId], references: [id])
  category        Category? @relation(fields: [categoryId], references: [id])
  document        StructuredDocument? @relation(fields: [documentId], references: [id])
  
  @@index([viewKey])
  @@index([userId, viewKey])
  @@index([role, viewKey])
  @@index([categoryId])
  @@index([documentId])
}
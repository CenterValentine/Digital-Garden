generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model ContentNode {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId       String           @db.Uuid
  title         String           @db.VarChar(255)
  slug          String           @db.VarChar(255)
  parentId      String?          @db.Uuid
  displayOrder  Int              @default(0)
  categoryId    String?          @db.Uuid
  isPublished   Boolean          @default(false)
  createdAt     DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime         @updatedAt @db.Timestamptz(6)
  deletedAt     DateTime?        @db.Timestamptz(6)
  deletedBy     String?          @db.Uuid
  customIcon    String?          @db.VarChar(100)
  iconColor     String?          @db.VarChar(20)
  auditLogs     AuditLog[]       @relation("AuditedContent")
  codePayload   CodePayload?
  history       ContentHistory[]
  sourceLinks   ContentLink[]    @relation("SourceContent")
  targetLinks   ContentLink[]    @relation("TargetContent")
  category      Category?        @relation(fields: [categoryId], references: [id])
  owner         User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  parent        ContentNode?     @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      ContentNode[]    @relation("Hierarchy")
  contentPath   ContentPath?
  contentTags   ContentTag[]
  filePayload   FilePayload?
  htmlPayload   HtmlPayload?
  notePayload   NotePayload?
  trashBinEntry TrashBin?
  viewGrants    ViewGrant[]

  @@unique([ownerId, slug])
  @@index([ownerId, deletedAt])
  @@index([parentId, displayOrder])
  @@index([categoryId, displayOrder])
  @@index([deletedAt])
}

model NotePayload {
  contentId  String      @id @db.Uuid
  tiptapJson Json
  searchText String      @default("")
  metadata   Json        @default("{}")
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime    @updatedAt @db.Timestamptz(6)
  content    ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([searchText(ops: raw("gin_trgm_ops"))], type: Gin)
}

model FilePayload {
  contentId        String          @id @db.Uuid
  fileName         String          @db.VarChar(255)
  fileExtension    String?         @db.VarChar(10)
  mimeType         String          @db.VarChar(127)
  fileSize         BigInt
  checksum         String          @db.VarChar(64)
  storageProvider  StorageProvider @default(r2)
  storageKey       String          @db.VarChar(512)
  storageUrl       String?
  storageMetadata  Json            @default("{}")
  uploadStatus     UploadStatus    @default(uploading)
  uploadedAt       DateTime?       @db.Timestamptz(6)
  uploadError      String?
  processingStatus String          @default("pending") @db.VarChar(20)
  isProcessed      Boolean         @default(false)
  thumbnailUrl     String?
  width            Int?
  height           Int?
  duration         Int?
  lastAccessedAt   DateTime?       @db.Timestamptz(6)
  createdAt        DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime        @updatedAt @db.Timestamptz(6)
  searchText       String          @default("")
  content          ContentNode     @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([uploadStatus])
  @@index([storageProvider, uploadedAt(sort: Desc)])
  @@index([checksum, fileSize])
  @@index([mimeType])
  @@index([processingStatus, isProcessed])
  @@index([searchText(ops: raw("gin_trgm_ops"))], type: Gin)
}

model HtmlPayload {
  contentId        String      @id @db.Uuid
  html             String
  searchText       String      @default("")
  isTemplate       Boolean     @default(false)
  templateSchema   Json?
  templateMetadata Json        @default("{}")
  renderMode       String      @default("static") @db.VarChar(20)
  templateEngine   String?     @db.VarChar(20)
  createdAt        DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime    @updatedAt @db.Timestamptz(6)
  content          ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([searchText(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([isTemplate])
}

model CodePayload {
  contentId  String      @id @db.Uuid
  code       String
  language   String      @db.VarChar(50)
  searchText String      @default("")
  metadata   Json        @default("{}")
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime    @updatedAt @db.Timestamptz(6)
  content    ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([searchText(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([language])
}

model ContentHistory {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contentId String      @db.Uuid
  version   Int
  snapshot  Json
  changedBy String      @db.Uuid
  changedAt DateTime    @default(now()) @db.Timestamptz(6)
  user      User        @relation(fields: [changedBy], references: [id])
  content   ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, version])
  @@index([contentId, version(sort: Desc)])
}

model ContentPath {
  contentId    String      @id @db.Uuid
  path         String      @db.VarChar(2048)
  pathSegments String[]
  depth        Int
  lastUpdated  DateTime    @updatedAt @db.Timestamptz(6)
  content      ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([path])
  @@index([depth])
}

model ContentLink {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sourceId       String      @db.Uuid
  targetId       String      @db.Uuid
  linkType       String      @db.VarChar(20)
  targetFragment String?     @db.VarChar(255)
  context        String?
  createdAt      DateTime    @default(now()) @db.Timestamptz(6)
  source         ContentNode @relation("SourceContent", fields: [sourceId], references: [id], onDelete: Cascade)
  target         ContentNode @relation("TargetContent", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId, linkType])
  @@index([targetId])
}

model ContentTag {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contentId String      @db.Uuid
  tagId     String      @db.Uuid
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  positions Json        @default("[]")
  content   ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag       Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contentId, tagId])
  @@index([tagId])
}

model TrashBin {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contentId         String      @unique @db.Uuid
  originalPath      String?
  deletedBy         String      @db.Uuid
  deletedAt         DateTime    @default(now()) @db.Timestamptz(6)
  scheduledDeletion DateTime    @db.Timestamptz(6)
  deletionReason    String?     @db.VarChar(255)
  contentSnapshot   Json
  content           ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)
  deletedByUser     User        @relation(fields: [deletedBy], references: [id])

  @@index([deletedBy])
  @@index([scheduledDeletion])
  @@index([deletedAt(sort: Desc)])
}

model StorageProviderConfig {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String          @db.Uuid
  provider    StorageProvider
  isDefault   Boolean         @default(false)
  displayName String?         @db.VarChar(100)
  config      Json
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime        @updatedAt @db.Timestamptz(6)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId, isDefault])
}

model User {
  id              String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username        String                  @unique @db.VarChar(50)
  passwordHash    String?                 @db.Char(60)
  email           String                  @unique @db.VarChar(255)
  role            UserRole                @default(guest)
  settings        Json?                   @db.JsonB
  settingsVersion Int                     @default(1)
  createdAt       DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime                @updatedAt @db.Timestamptz(6)
  accounts        Account[]
  adminActions    AuditLog[]              @relation("AdminActions")
  auditTargets    AuditLog[]              @relation("AuditTargets")
  categories      Category[]
  contentHistory  ContentHistory[]
  contentNodes    ContentNode[]
  sessions        Session[]
  storageConfigs  StorageProviderConfig[]
  tags            Tag[]
  trashedContent  TrashBin[]
  viewGrants      ViewGrant[]

  @@index([email])
}

model Category {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String        @db.VarChar(100)
  slug         String        @unique @db.VarChar(100)
  description  String?
  ownerId      String        @db.Uuid
  displayOrder Int           @default(0)
  isPublished  Boolean       @default(false)
  createdAt    DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6)
  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  contentNodes ContentNode[]

  @@index([ownerId, displayOrder])
}

model Tag {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String       @db.VarChar(50)
  slug        String       @db.VarChar(50)
  createdAt   DateTime     @default(now()) @db.Timestamptz(6)
  color       String?      @db.VarChar(7)
  userId      String       @db.Uuid
  contentTags ContentTag[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId, name])
}

model ViewGrant {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contentId   String      @db.Uuid
  userId      String      @db.Uuid
  accessLevel String      @db.VarChar(20)
  grantedAt   DateTime    @default(now()) @db.Timestamptz(6)
  expiresAt   DateTime?   @db.Timestamptz(6)
  content     ContentNode @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([contentId, userId])
  @@index([userId])
}

model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Account {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String    @db.Uuid
  provider          String    @db.VarChar(50)
  providerAccountId String    @db.VarChar(255)
  refreshToken      String?
  accessToken       String?
  expiresAt         DateTime? @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@unique([provider, providerAccountId], map: "Account_provider_providerAccId_key")
  @@index([userId])
  @@index([provider])
}

model AuditLog {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String       @db.Uuid
  action          String       @db.VarChar(100)
  targetUserId    String?      @db.Uuid
  targetContentId String?      @db.Uuid
  details         Json         @default("{}")
  ipAddress       String?      @db.VarChar(45)
  userAgent       String?      @db.VarChar(512)
  createdAt       DateTime     @default(now()) @db.Timestamptz(6)
  user            User         @relation("AdminActions", fields: [userId], references: [id], onDelete: Cascade)
  targetUser      User?        @relation("AuditTargets", fields: [targetUserId], references: [id], onDelete: SetNull)
  targetContent   ContentNode? @relation("AuditedContent", fields: [targetContentId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)])
  @@index([targetUserId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

enum UserRole {
  owner
  admin
  member
  guest
}

enum UploadStatus {
  uploading
  ready
  failed
}

enum StorageProvider {
  r2
  s3
  vercel
}
